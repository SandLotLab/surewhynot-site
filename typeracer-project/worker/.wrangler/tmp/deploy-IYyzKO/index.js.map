{
  "version": 3,
  "sources": ["../../../index.js"],
  "sourceRoot": "C:\\Users\\BigHomieCed\\Desktop\\GitHub\\surewhynot-site\\typeracer-project\\worker\\.wrangler\\tmp\\deploy-IYyzKO",
  "sourcesContent": ["export class RoomDurableObject {\r\n  constructor(state, env) {\r\n    this.state = state;\r\n    this.env = env;\r\n    this.clients = [];\r\n    this.players = {};\r\n    this.gameText = null;\r\n    this.raceFinished = false;\r\n  }\r\n\r\n  pickGoofyName() {\r\n  const pool = [\r\n    \"CaptainWaffles\",\"SirTyposALot\",\"QuantumBanana\",\"TurboHamster\",\"ByteMeBro\",\r\n    \"404SpeedNotFound\",\"MajesticToaster\",\"ColonelKeyboard\",\"SpaceSausage\",\r\n    \"LintWizard\",\"NeonPotato\",\"PanicAtTheDiscoKey\",\"FuzzyFirewall\",\"CryptoPenguin\",\r\n    \"LatencyLlama\",\"PacketPirate\",\"SyntaxSamurai\",\"WPMWarlock\",\"GremlinGears\",\r\n    \"GlitchGoblin\",\"ChonkChampion\",\"SnackOps\",\"NullPointerNinja\",\"MemeMachine\"\r\n  ];\r\n\r\n  const used = new Set(Object.keys(this.players));\r\n  const available = pool.filter(n => !used.has(n));\r\n\r\n  if (available.length) {\r\n    return available[Math.floor(Math.random() * available.length)];\r\n  }\r\n\r\n  // fallback if pool exhausted\r\n  let n = Object.keys(this.players).length + 1;\r\n  let candidate = `ChaosGoblin${n}`;\r\n  while (used.has(candidate)) { n++; candidate = `ChaosGoblin${n}`; }\r\n  return candidate;\r\n}\r\n\r\n  async fetch(request) {\r\n    if (request.headers.get(\"Upgrade\") !== \"websocket\") {\r\n      return new Response(\"Expected WebSocket\", { status: 426 });\r\n    }\r\n\r\n    if (this.raceFinished || Object.keys(this.players).length >= 4) {\r\n      return new Response(\"Room closed or full\", { status: 403 });\r\n    }\r\n\r\n    const roomId = this.state.id.toString();\r\n\r\n    if (!this.gameText) {\r\n      const kvKey = `room:${roomId}:text`;\r\n      let text = await this.env.ROOM_STATE.get(kvKey);\r\n\r\n      if (!text) {\r\n        const snippets = [\r\n          \"The quick brown fox jumps over the lazy dog.\",\r\n          \"Cloudflare Workers let you run JavaScript on the edge.\",\r\n          \"Durable Objects are useful for real-time apps.\",\r\n        ];\r\n        text = snippets[Math.floor(Math.random() * snippets.length)];\r\n        await this.env.ROOM_STATE.put(kvKey, text, { expirationTtl: 600 });\r\n      }\r\n\r\n      this.gameText = text;\r\n    }\r\n\r\n    const pair = new WebSocketPair();\r\n    const client = pair[0];\r\n    const server = pair[1];\r\n    server.accept();\r\n\r\n    const playerId = this.pickGoofyName();\r\n    this.players[playerId] = 0;\r\n    this.clients.push(server);\r\n\r\n    server.send(\r\n      JSON.stringify({\r\n        event: \"init\",\r\n        text: this.gameText,\r\n        you: playerId,\r\n        players: this.players,\r\n      })\r\n    );\r\n\r\n    this.broadcast(JSON.stringify({ event: \"join\", player: playerId }), server);\r\n\r\n    server.addEventListener(\"message\", async (msgEvt) => {\r\n      try {\r\n        const data = JSON.parse(msgEvt.data);\r\n\r\n        if (data.event === \"progress\") {\r\n          if (this.raceFinished) return;\r\n          const { player, charsTyped } = data;\r\n          this.players[player] = charsTyped;\r\n          this.broadcast(\r\n            JSON.stringify({ event: \"update\", player, charsTyped }),\r\n            server\r\n          );\r\n        }\r\n\r\n        if (data.event === \"finish\") {\r\n          const { player, time } = data;\r\n          if (!this.raceFinished) {\r\n            this.raceFinished = true;\r\n            this.broadcast(JSON.stringify({ event: \"finish\", player, time }), null);\r\n\r\n            const kvKey = `room:${this.state.id.toString()}:text`;\r\n            await this.env.ROOM_STATE.delete(kvKey);\r\n          }\r\n        }\r\n      } catch (err) {\r\n        console.error(\"DO message error:\", err);\r\n      }\r\n    });\r\n\r\n    server.addEventListener(\"close\", () => {\r\n      this.clients = this.clients.filter((ws) => ws !== server);\r\n      if (this.clients.length === 0) {\r\n        this.state.storage.deleteAll();\r\n      }\r\n    });\r\n\r\n    return new Response(null, { status: 101, webSocket: client });\r\n  }\r\n\r\n  broadcast(message, exceptServer = null) {\r\n    for (const ws of this.clients) {\r\n      if (ws !== exceptServer) {\r\n        try {\r\n          ws.send(message);\r\n        } catch {}\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction corsHeaders(origin = \"*\") {\r\n  return {\r\n    \"Access-Control-Allow-Origin\": origin,\r\n    \"Access-Control-Allow-Methods\": \"GET,POST,OPTIONS\",\r\n    \"Access-Control-Allow-Headers\": \"Content-Type\",\r\n  };\r\n}\r\n\r\nexport default {\r\n  async fetch(request, env) {\r\n    const url = new URL(request.url);\r\n\r\n    // \u2705 IMPORTANT: your Worker is mounted at /typeracer-ws/*\r\n    // so we strip that prefix so your routes still match.\r\n    const PREFIX = \"/typeracer-ws\";\r\n    let path = url.pathname;\r\n    if (path.startsWith(PREFIX)) path = path.slice(PREFIX.length) || \"/\";\r\n\r\n    // CORS preflight\r\n    if (request.method === \"OPTIONS\") {\r\n      return new Response(null, { status: 204, headers: corsHeaders(\"*\") });\r\n    }\r\n\r\n    if (path === \"/createRoom\") {\r\n      const code = Math.random().toString(36).slice(2, 10);\r\n      env.ROOM_DO.idFromName(code); // ensures consistent name \u2192 DO id mapping\r\n      return new Response(code, { status: 200, headers: corsHeaders(\"*\") });\r\n    }\r\n\r\n    if (path.startsWith(\"/room/\")) {\r\n      const roomCode = path.split(\"/\")[2];\r\n      if (!roomCode) return new Response(\"Room ID required\", { status: 400 });\r\n\r\n      const roomId = env.ROOM_DO.idFromName(roomCode);\r\n      const roomObject = env.ROOM_DO.get(roomId);\r\n      return roomObject.fetch(request);\r\n    }\r\n\r\n    return new Response(\"Not found\", { status: 404, headers: corsHeaders(\"*\") });\r\n  },\r\n};\r\n"],
  "mappings": "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",
  "names": ["n"]
}
