# ===============================
# SureWhyNot Site Audit Script
# ===============================

$domain = "https://surewhynot.app"

$urls = @(
    "$domain/",
    "$domain/ads.txt",
    "$domain/robots.txt",
    "$domain/sitemap.xml"
)

function Get-UrlSafe {
    param($url)

    try {
        # Use .NET HttpClient so 308 redirects are followed cleanly
        $handler = New-Object System.Net.Http.HttpClientHandler
        $handler.AllowAutoRedirect = $true

        $client = New-Object System.Net.Http.HttpClient($handler)
        $client.DefaultRequestHeaders.Add("User-Agent","SWY-Audit")

        $response = $client.GetAsync($url).Result
        $status = [int]$response.StatusCode
        $headers = $response.Headers
        $content = $response.Content.ReadAsStringAsync().Result

        return @{
            Status  = $status
            Headers = $headers
            Body    = $content
        }
    }
    catch {
        Write-Host "ERROR: $($_.Exception.Message)"
        return $null
    }
}

Write-Host "`n========== BASIC SITE CHECK =========="

foreach ($url in $urls) {
    Write-Host "`n===== $url ====="

    $r = Get-UrlSafe $url

    if ($r -ne $null) {
        Write-Host "Status: $($r.Status)"
        Write-Host "Content-Type: $($r.Headers.'Content-Type')"
        Write-Host "Server: $($r.Headers.Server)"
        Write-Host "Cache-Control: $($r.Headers.'Cache-Control')"
        Write-Host "X-Robots-Tag: $($r.Headers.'X-Robots-Tag')"
        Write-Host "CSP: $($r.Headers.'Content-Security-Policy')"
        Write-Host "X-Frame-Options: $($r.Headers.'X-Frame-Options')"
        Write-Host "Referrer-Policy: $($r.Headers.'Referrer-Policy')"
        Write-Host "Permissions-Policy: $($r.Headers.'Permissions-Policy')"
        Write-Host "Strict-Transport-Security: $($r.Headers.'Strict-Transport-Security')"

        Write-Host "`n---- First 60 lines of body ----"
        $r.Body -split "`n" | Select-Object -First 60 | ForEach-Object { Write-Host $_ }
    }
}

Write-Host "`n========== PARTIAL LINKS (header/footer) =========="

$partials = @(
    "$domain/partials/header.html",
    "$domain/partials/footer.html"
)

foreach ($p in $partials) {
    Write-Host "`n===== $p ====="
    $r = Get-UrlSafe $p

    if ($r -ne $null) {
        Write-Host "Status: $($r.Status)"
        if ($r.Status -eq 200) {
            Write-Host "Loaded OK"
        }
    }
    else {
        Write-Host "Missing or unreachable"
    }
}

Write-Host "`n========== DONE =========="
