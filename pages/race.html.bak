<script>
  const texts = [
    "Systems behave perfectly until humans decide to test them.",
    "A clean interface is a lie told politely to chaos.",
    "Stability is not calm. It is maintenance done on time.",
    "Type fast, think faster, and do not trust the first draft.",
    "The machine is consistent. The operator is the variable.",
    "Speed is a skill. Accuracy is a choice. Pick both."
  ];

  const $ = (id) => document.getElementById(id);

  const state = {
    target: "",
    started: false,
    startAt: 0,
    raf: 0,
    done: false,
    best: Number(localStorage.getItem("swn_typerace_best") || "0")
  };

  function pickText(){
    state.target = texts[Math.floor(Math.random() * texts.length)];
    renderText("");
    $("raceInput").value = "";
    $("raceFill").style.width = "0%";
    $("raceTime").textContent = "Time: 0.0s";
    $("raceWpm").textContent = "WPM: 0";
    $("raceAcc").textContent = "Acc: 100%";
    $("raceHint").textContent = "Press Start, then type. Timer begins on first keystroke.";
    state.started = false;
    state.done = false;
    cancelAnimationFrame(state.raf);
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  function renderText(typed){
    const t = state.target;
    let html = "";
    for (let i = 0; i < t.length; i++){
      const ch = t[i];
      const u = typed[i];
      if (u === undefined) html += `<span class="todo">${escapeHtml(ch)}</span>`;
      else if (u === ch) html += `<span class="ok">${escapeHtml(ch)}</span>`;
      else html += `<span class="bad">${escapeHtml(ch)}</span>`;
    }
    $("raceText").innerHTML = html;
  }

  function metrics(typed, elapsedSec){
    const t = state.target;

    let correct = 0;
    for (let i = 0; i < typed.length; i++) if (typed[i] === t[i]) correct++;
    const acc = typed.length ? (correct / typed.length) : 1;

    const minutes = Math.max(elapsedSec / 60, 1/6000);
    const wpm = Math.max(0, Math.round((correct / 5) / minutes));

    const progress = Math.min(1, typed.length / t.length);

    return { acc, wpm, progress };
  }

  function tick(){
    if (!state.started || state.done) return;
    const now = performance.now();
    const elapsed = (now - state.startAt) / 1000;
    $("raceTime").textContent = `Time: ${elapsed.toFixed(1)}s`;

    const typed = $("raceInput").value;
    const { acc, wpm, progress } = metrics(typed, elapsed);

    $("raceWpm").textContent = `WPM: ${wpm}`;
    $("raceAcc").textContent = `Acc: ${Math.round(acc * 100)}%`;
    $("raceFill").style.width = `${Math.round(progress * 100)}%`;

    state.raf = requestAnimationFrame(tick);
  }

  function updateBest(){
    $("raceBest").textContent = state.best ? `Best: ${state.best} WPM` : "Best: –";
  }

  $("raceNew").onclick = pickText;
  $("raceStart").onclick = () => { $("raceInput").focus(); $("raceHint").textContent = "Typing…"; };
  $("raceReset").onclick = () => { pickText(); updateBest(); };

  $("raceInput").addEventListener("input", () => {
    const typed = $("raceInput").value;

    if (!state.started && typed.length){
      state.started = true;
      state.startAt = performance.now();
      cancelAnimationFrame(state.raf);
      state.raf = requestAnimationFrame(tick);
    }

    renderText(typed);

    const elapsed = state.started ? (performance.now() - state.startAt) / 1000 : 0.0001;
    const { wpm, progress } = metrics(typed, elapsed);
    $("raceFill").style.width = `${Math.round(progress * 100)}%`;

    if (!state.done && typed === state.target){
      state.done = true;
      cancelAnimationFrame(state.raf);
      $("raceHint").textContent = "Finished.";

      if (wpm > state.best){
        state.best = wpm;
        localStorage.setItem("swn_typerace_best", String(wpm));
        updateBest();
      }
    }
  });

  pickText();
  updateBest();
</script>

<script type="module">
  import { injectTopbar, injectChatWidget } from "/assets/js/app.js";
  injectTopbar("race");
  injectChatWidget();
</script>

</body>
</html>
