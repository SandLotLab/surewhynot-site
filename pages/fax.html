<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fax — surewhynot.app</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>

<body>
  <div class="shell" data-topbar>
    <div class="card">
      <h1>Digital Fax</h1>
      <div class="tiny">Free up to 5 pages/day. $0.10 per page after.</div>

      <label>To (fax number)</label>
      <input id="faxTo" placeholder="+1 555 555 5555">

      <label>From (name)</label>
      <input id="faxFrom" placeholder="surewhynot.app">

      <label>Cover message</label>
      <textarea id="faxMsg" placeholder="Write cover page text…"></textarea>

      <label>Attach file</label>
      <input type="file" id="faxFile"
             accept="application/pdf,image/png,image/jpeg,text/plain,.pdf,.png,.jpg,.jpeg,.txt">

      <div class="btns">
        <button class="primary" id="faxSubmit">Submit</button>
        <button id="faxSend" disabled>Send fax</button>
      </div>

      <div class="out" id="faxOut" style="min-height:auto;"></div>
      <div class="tiny" id="faxStatus"></div>
    </div>

    <div class="footer">
      <a href="/pages/about.html">About</a> ·
      <a href="/pages/privacy.html">Privacy</a> ·
      <a href="/pages/contact.html">Contact</a>
    </div>
  </div>

  <!-- Email verification modal -->
  <div id="verifyModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.65); padding:18px; z-index:9999;">
    <div style="width:min(520px,100%); background:rgba(11,15,20,0.98); border:1px solid rgba(255,255,255,0.10); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.45);">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div style="font-size:14px; opacity:.95;">Verify your email</div>
        <button id="verifyClose" style="padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.06); color:#e8edf5; cursor:pointer;">X</button>
      </div>

      <div class="tiny" style="margin-top:8px;">
        Enter your email. We’ll send a link. Click it, then come back here and hit <b>Send fax</b>.
      </div>

      <label style="margin-top:12px;">Email</label>
      <input id="verifyEmail" type="email" placeholder="you@domain.com" autocomplete="email"
             style="width:100%; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.35); color:#e8edf5; outline:none;">

      <div class="btns" style="margin-top:12px;">
        <button class="primary" id="verifySend">Send verification link</button>
        <button id="verifyReset">Reset</button>
      </div>

      <div class="tiny" id="verifyStatus" style="margin-top:8px;"></div>
    </div>
  </div>

<script type="module">
  import { injectTopbar } from "/assets/js/app.js";
  injectTopbar("fax");

  const $ = (id) => document.getElementById(id);

  const STORAGE_KEY = "fax_submit_state_v3";
  const VERIFY_TTL_MS = 30 * 60 * 1000;

  function setStatus(t){ $("faxStatus").textContent = t || ""; }
  function out(t){ $("faxOut").textContent = t || ""; }
  function setVStatus(t){ $("verifyStatus").textContent = t || ""; }

  function showModal(){ $("verifyModal").style.display = "flex"; }
  function hideModal(){ $("verifyModal").style.display = "none"; }

  function getState(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch { return {}; }
  }
  function setState(s){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(s || {}));
  }
  function clearState(){
    localStorage.removeItem(STORAGE_KEY);
  }

  function enableSendIfVerified(){
    const st = getState();
    const ok = !!(st && st.submission_id && st.verified_email && st.verified_at && (Date.now() - st.verified_at) <= VERIFY_TTL_MS);
    $("faxSend").disabled = !ok;
    return ok;
  }

  function summarizePending(){
    const st = getState();
    if (!st || !st.submission_id) return;

    out(
      `Submission: ${st.submission_id}\n` +
      `To: ${st.to || ""}\n` +
      `From: ${st.from || ""}\n` +
      `File: ${st.fileName || ""}\n` +
      `Status: ${st.verified_at ? "email verified" : "email not verified"}\n`
    );
  }

  function getSubmissionIdFromUrl(){
    const url = new URL(location.href);

    // 1) ?submission_id=
    let sid = url.searchParams.get("submission_id");
    if (sid) return sid;

    // 2) last path segment if you ever do /pages/fax/<id>
    const parts = url.pathname.split("/").filter(Boolean);
    const last = parts[parts.length - 1] || "";
    // crude guard so we don't treat "fax.html" as an id
    if (last && last !== "fax.html" && last !== "fax") return last;

    return null;
  }

  function setSubmissionIdInUrl(sid){
    const url = new URL(location.href);
    url.searchParams.set("submission_id", sid);
    // keep token if present, but not needed; leaving it doesn't hurt
    history.replaceState({}, "", url.toString());
  }

  async function confirmTokenIfPresent(){
    const url = new URL(location.href);
    const token = url.searchParams.get("token");
    if (!token) return null;

    try {
      const r = await fetch(`/api/fax/verify/confirm?token=${encodeURIComponent(token)}`, { method: "GET" });
      const j = await r.json().catch(()=>null);
      if (!r.ok || !j) return null;

      // expect server to give us submission_id (handle a couple shapes)
      const sid = j.submission_id || j.submissionId || j?.data?.submission_id || null;
      if (!sid) return null;

      setSubmissionIdInUrl(sid);
      return sid;
    } catch {
      return null;
    }
  }

  async function hydrateFromStatus(){
    // If we arrived via token link, confirm it first and derive submission_id
    let submissionId = await confirmTokenIfPresent();
    if (!submissionId) submissionId = getSubmissionIdFromUrl();
    if (!submissionId) return;

    try {
      const r = await fetch(`/api/fax/status?submission_id=${encodeURIComponent(submissionId)}`);
      const j = await r.json().catch(()=>null);
      if (!r.ok || !j) return;

      // normalize common shapes
      const sid = j.submission_id || j.submissionId || submissionId;
      const to = j.to || j.faxTo || j.destination || "";
      const from = j.from || j.faxFrom || j.source || "";
      const cover = j.message || j.cover || j.coverMessage || "";
      const fileName = j.file || j.fileName || j.filename || "";

      // Prefill visible form fields so the page isn't "blank" after verify
      if (to) $("faxTo").value = to;
      if (from) $("faxFrom").value = from;
      if (cover) $("faxMsg").value = cover;

      const st = getState() || {};
      st.submission_id = sid;
      st.to = to || st.to;
      st.from = from || st.from;
      st.fileName = fileName || st.fileName;

      // Verified markers (support a few keys)
      const verified = !!(j.verified || j.email_verified || j.emailVerified);
      const verifiedEmail = j.verifiedEmail || j.email || j.verified_email || j.emailVerifiedFor || null;

      st.verified_email = verifiedEmail || st.verified_email || null;
      st.verified_at = verified ? Date.now() : st.verified_at || null;

      setState(st);

      summarizePending();
      enableSendIfVerified();
    } catch {}
  }

  $("verifyClose").onclick = hideModal;

  $("verifyReset").onclick = () => {
    const st = getState();
    if (st) {
      delete st.verified_email;
      delete st.verified_at;
      setState(st);
    }
    setVStatus("Verification reset.");
    enableSendIfVerified();
    summarizePending();
  };

  $("faxSubmit").onclick = async () => {
    const to = $("faxTo").value.trim();
    const from = $("faxFrom").value.trim();
    const msg = $("faxMsg").value.trim();
    const f = $("faxFile").files && $("faxFile").files[0];

    if (!to) return setStatus("Missing fax number.");
    if (!f)  return setStatus("Attach a file.");

    setStatus("Submitting…");
    out("");

    const fd = new FormData();
    fd.append("to", to);
    //fd.append("from", from);
    fd.append("message", msg);
    fd.append("file", f, f.name);

    try {
      const r = await fetch("/api/fax/draft", { method:"POST", body: fd });
      const j = await r.json().catch(()=>null);

      if (!r.ok || !j || !j.submission_id) {
        out(`Error: ${r.status}`);
        setStatus(j?.error || "Failed.");
        return;
      }

      // Put submission_id into URL so refresh / returning works
      setSubmissionIdInUrl(j.submission_id);

      setState({
        submission_id: j.submission_id,
        to, from,
        fileName: f.name,
        created_at: Date.now(),
      });

      setStatus("Submitted. Verify email to unlock Send.");
      summarizePending();
      enableSendIfVerified();
      showModal();
      $("verifyEmail").value = "";
      setVStatus("");
    } catch {
      setStatus("Failed.");
    }
  };

  $("verifySend").onclick = async () => {
    const email = $("verifyEmail").value.trim();
    const st = getState();

    if (!st || !st.submission_id) return setVStatus("No submitted fax found. Click Submit first.");
    if (!email) return setVStatus("Enter your email.");

    setVStatus("Sending verification email…");

    try {
      const r = await fetch("/api/fax/verify/start", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ submission_id: st.submission_id, email })
      });
      const j = await r.json().catch(()=>null);

      if (!r.ok || !j) {
        setVStatus("Failed to send verification email.");
        return;
      }

      setVStatus("Verification email sent. Click the link, then come back and press Send fax.");
    } catch {
      setVStatus("Failed to send verification email.");
    }
  };

  $("faxSend").onclick = async () => {
    const st = getState();
    if (!st || !st.submission_id) return;

    if (!enableSendIfVerified()) {
      setStatus("Verify your email first.");
      showModal();
      return;
    }

    setStatus("Sending…");

    try {
      const r = await fetch("/api/fax/send", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ submission_id: st.submission_id })
      });

      const j = await r.json().catch(()=>null);

      if (r.status === 402 && j?.pricing) {
        setStatus(`Payment required: $${(j.pricing.dueCents/100).toFixed(2)} (${j.pricing.paidPages} page(s)). Redirecting…`);

        const pr = await fetch("/api/fax/pay/create", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ submission_id: st.submission_id })
        });
        const pj = await pr.json().catch(()=>null);

        if (!pr.ok || !pj?.url) {
          setStatus(pj?.error || "Payment create failed.");
          return;
        }

        location.href = pj.url;
        return;
      }

      if (!r.ok || !j) {
        setStatus(j?.error || "Failed.");
        if (j?.sinch) out(JSON.stringify(j.sinch, null, 2));
        return;
      }

      out(
        `Submission: ${st.submission_id}\n` +
        `To: ${st.to}\n` +
        `From: ${st.from}\n` +
        (j.pages ? `Pages: ${j.pages}\n` : "") +
        (j.status ? `Status: ${j.status}\n` : "")
      );

      setStatus("Queued.");
      clearState();
      $("faxSend").disabled = true;

    } catch {
      setStatus("Failed.");
    }
  };

  // Init
  await hydrateFromStatus();
  enableSendIfVerified();
  summarizePending();
</script>

</body>
</html>
