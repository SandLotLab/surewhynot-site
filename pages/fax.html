<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fax — surewhynot.app</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>

<body>
  <div class="shell" data-topbar>
    <div class="card">
      <h1>Digital Fax</h1>
      <div class="tiny">Free up to 5 pages. Email verification happens after you submit.</div>

      <label>To (fax number)</label>
      <input id="faxTo" placeholder="+1 555 555 5555">

      <label>From (name)</label>
      <input id="faxFrom" placeholder="surewhynot.app">

      <label>Cover message</label>
      <textarea id="faxMsg" placeholder="Write cover page text…"></textarea>

      <label>Attach PDF</label>
      <input type="file" id="faxFile" accept="application/pdf">

      <div class="btns">
        <button class="primary" id="faxSubmit">Submit</button>
        <button id="faxSend" disabled>Send fax</button>
      </div>

      <div class="out" id="faxOut" style="min-height:auto;"></div>
      <div class="tiny" id="faxStatus"></div>
    </div>

    <div class="footer">
      <a href="/pages/about.html">About</a> ·
      <a href="/pages/privacy.html">Privacy</a> ·
      <a href="/pages/contact.html">Contact</a>
    </div>
  </div>

  <!-- Email verification modal -->
  <div id="verifyModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.65); padding:18px; z-index:9999;">
    <div style="width:min(520px,100%); background:rgba(11,15,20,0.98); border:1px solid rgba(255,255,255,0.10); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.45);">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div style="font-size:14px; opacity:.95;">Verify your email</div>
        <button id="verifyClose" style="padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.06); color:#e8edf5; cursor:pointer;">X</button>
      </div>

      <div class="tiny" style="margin-top:8px;">
        Enter your email. We’ll send a link. Click it, then come back here and hit <b>Send fax</b>.
      </div>

      <label style="margin-top:12px;">Email</label>
      <input id="verifyEmail" type="email" placeholder="you@domain.com" autocomplete="email" style="width:100%; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.35); color:#e8edf5; outline:none;">

      <div class="btns" style="margin-top:12px;">
        <button class="primary" id="verifySend">Send verification link</button>
        <button id="verifyReset">Reset</button>
      </div>

      <div class="tiny" id="verifyStatus" style="margin-top:8px;"></div>
    </div>
  </div>

<script type="module">
  import { injectTopbar } from "/assets/js/app.js";
  injectTopbar("fax");

  const $ = (id) => document.getElementById(id);

  const STORAGE_KEY = "fax_submit_state_v2";
  const VERIFY_TTL_MS = 30 * 60 * 1000; // 30 min

  function setStatus(t){ $("faxStatus").textContent = t || ""; }
  function out(t){ $("faxOut").textContent = t || ""; }
  function setVStatus(t){ $("verifyStatus").textContent = t || ""; }

  function showModal(){ $("verifyModal").style.display = "flex"; }
  function hideModal(){ $("verifyModal").style.display = "none"; }

  function getState(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch { return {}; }
  }
  function setState(s){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(s || {}));
  }
  function clearState(){
    localStorage.removeItem(STORAGE_KEY);
  }

  function enableSendIfVerified(){
    const st = getState();
    const ok = !!(st && st.submission_id && st.verified_email && st.verified_at && (Date.now() - st.verified_at) <= VERIFY_TTL_MS);
    $("faxSend").disabled = !ok;
    return ok;
  }

  function summarizePending(){
    const st = getState();
    if (!st || !st.submission_id) return;

    out(
      `Submission: ${st.submission_id}\n` +
      `To: ${st.to}\n` +
      `From: ${st.from}\n` +
      `PDF: ${st.fileName}\n` +
      `Status: ${st.verified_at ? "email verified" : "email not verified"}\n`
    );
  }

  // If your verification link sends them back like:
  // /pages/fax.html?fax_verify=1&submission_id=...&email=...
  async function hydrateFromStatus(){
  const url = new URL(location.href);
  const submissionId = url.searchParams.get("submission_id");
  if (!submissionId) return;

  try {
    const r = await fetch(`/api/fax/status?submission_id=${encodeURIComponent(submissionId)}`);
    const j = await r.json().catch(()=>null);
    if (!r.ok || !j) return;

    const st = getState() || {};
    st.submission_id = j.submission_id;
    st.verified_email = j.verifiedEmail || null;
    st.verified_at = j.verified ? Date.now() : null; // UI gate only
    setState(st);
  } catch {}
}

  $("verifyClose").onclick = hideModal;

  $("verifyReset").onclick = () => {
    const st = getState();
    if (st) {
      delete st.verified_email;
      delete st.verified_at;
      setState(st);
    }
    setVStatus("Verification reset.");
    enableSendIfVerified();
    summarizePending();
  };

  $("faxSubmit").onclick = async () => {
    const to = $("faxTo").value.trim();
    const from = $("faxFrom").value.trim() || "surewhynot.app";
    const msg = $("faxMsg").value.trim();
    const f = $("faxFile").files && $("faxFile").files[0];

    if (!to) return setStatus("Missing fax number.");
    if (!f)  return setStatus("Attach a PDF.");

    setStatus("Submitting…");
    out("");

    // Submit the fax payload (without sending). Backend returns submission_id.
    // Endpoint placeholder: /api/fax/draft
    const fd = new FormData();
    fd.append("to", to);
    fd.append("from", from);
    fd.append("message", msg);
    fd.append("file", f, f.name);

    try {
      const r = await fetch("/api/fax/draft", { method:"POST", body: fd });
      const j = await r.json().catch(()=>null);

      if (!r.ok || !j || !j.submission_id) {
        out(`Error: ${r.status}`);
        setStatus(j?.error || "Failed.");
        return;
      }

      setState({
        submission_id: j.submission_id,
        to, from,
        fileName: f.name,
        created_at: Date.now(),
        // verification fields set later
      });

      setStatus("Submitted. Verify email to unlock Send.");
      summarizePending();
      enableSendIfVerified();
      showModal();
      $("verifyEmail").value = "";
      setVStatus("");
    } catch {
      setStatus("Failed.");
    }
  };

  $("verifySend").onclick = async () => {
    const email = $("verifyEmail").value.trim();
    const st = getState();

    if (!st || !st.submission_id) return setVStatus("No submitted fax found. Click Submit first.");
    if (!email) return setVStatus("Enter your email.");

    setVStatus("Sending verification email…");

    // Backend should email a link that returns them to this page with:
    // ?fax_verify=1&submission_id=...&email=...
    try {
      const r = await fetch("/api/fax/verify/start", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ submission_id: st.submission_id, email })
      });
      const j = await r.json().catch(()=>null);

      if (!r.ok || !j) {
        setVStatus("Failed to send verification email.");
        return;
      }

      setVStatus("Verification email sent. Click the link, then come back and press Send fax.");
    } catch {
      setVStatus("Failed to send verification email.");
    }
  };

  $("faxSend").onclick = async () => {
    const st = getState();
    if (!st || !st.submission_id) return;

    if (!enableSendIfVerified()) {
      setStatus("Verify your email first.");
      showModal();
      return;
    }

    setStatus("Sending…");

    try {
      // Backend sends the fax now that email is verified.
      // Endpoint placeholder: /api/fax/send
      const r = await fetch("/api/fax/send", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ submission_id: st.submission_id })
      });
      const j = await r.json().catch(()=>null);

      if (!r.ok || !j) {
        setStatus(j?.error || "Failed.");
        return;
      }

      out(
        `Submission: ${st.submission_id}\n` +
        `To: ${st.to}\n` +
        `From: ${st.from}\n` +
        (j.pages ? `Pages: ${j.pages}\n` : "") +
        (j.mode ? `Mode: ${j.mode}\n` : "") +
        (j.status ? `Fax status: ${j.status}\n` : "Fax queued.\n")
      );

      setStatus("Sent/queued.");
    } catch {
      setStatus("Failed.");
    }
  };

  // Init
  await hydrateFromStatus();
  enableSendIfVerified();
  summarizePending();

</script>

</body>
</html>

