<!-- Updated /mnt/data/race.html (adds Practice, Instant Death, Online Random, Online Friends) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TypeRace — surewhynot.app</title>
  <link rel="stylesheet" href="/assets/css/style.css">
  <style>
    .raceText{ line-height:1.6; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.25); }
    .todo{ opacity:.75; }
    .ok{ opacity:1; text-decoration:underline; }
    .bad{ opacity:1; text-decoration:underline; }
    .meter{ height:10px; border-radius:999px; border:1px solid rgba(255,255,255,0.10); background:rgba(255,255,255,0.06); overflow:hidden; }
    .meter>div{ height:100%; width:0%; background:rgba(255,200,80,0.45); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .mini{ font-size:12px; opacity:.75; }
    textarea{ width:100%; }
    .panel{ margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.22); }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:760px){ .grid2{ grid-template-columns: 1fr; } }
    input, select{
      padding:8px 10px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(0,0,0,0.35); color:#e8edf5; outline:none;
    }
    .leader{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .pRow{ display:flex; gap:10px; align-items:center; }
    .pTag{ min-width: 110px; font-size:12px; opacity:.85; }
    .pBar{ flex:1; height:8px; border-radius:999px; border:1px solid rgba(255,255,255,0.10); background:rgba(255,255,255,0.06); overflow:hidden; }
    .pBar>div{ height:100%; width:0%; background:rgba(255,200,80,0.45); }
    .pill{ font-size:12px; opacity:.85; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); padding:6px 10px; border-radius:999px; }
  </style>
</head>

<body>
  <div class="shell" data-topbar>
    <div class="card">
      <h1>TypeRace</h1>

      <div class="panel">
        <div class="grid2">
          <div>
            <div class="mini" style="margin-bottom:6px;">Mode</div>
            <select id="mode">
              <option value="practice">Practice (solo)</option>
              <option value="instant">Instant Death (solo)</option>
              <option value="online_random">Online Casual — Random</option>
              <option value="online_friends">Online Casual — Friends (room code)</option>
            </select>
          </div>
         
        </div>

        <div id="onlineControls" style="display:none; margin-top:10px;">
          <div class="row">
            <input id="nick" placeholder="Nick (optional)" style="min-width:160px;">
            <input id="room" placeholder="Room code (friends mode)" style="min-width:180px;">
            <button class="primary" id="onlineJoin">Join</button>
            <button id="onlineLeave" disabled>Leave</button>
            <span class="pill" id="onlineStatus">Offline</span>
          </div>
          <div class="leader" id="leader"></div>
        </div>
      </div>

      <div class="row">
        <button class="primary" id="raceNew">New text</button>
        <button id="raceStart">Start</button>
        <button id="raceReset">Reset</button>
        <div class="mini" id="raceTime">Time: 0.0s</div>
        <div class="mini" id="raceWpm">WPM: 0</div>
        <div class="mini" id="raceAcc">Acc: 100%</div>
        <div class="mini" id="raceBest">Best: –</div>
      </div>

      <div style="margin-top:10px;" class="raceText" id="raceText"></div>

      <div style="margin-top:10px;" class="meter">
        <div id="raceFill"></div>
      </div>

      <div style="margin-top:10px;">
        <label>Type here</label>
        <textarea id="raceInput" placeholder="Start typing…" style="min-height:70px;"></textarea>
        <div class="tiny" id="raceHint">Press Start, then type. Timer begins on first keystroke.</div>
      </div>
    </div>

    <div class="footer">
      <a href="/pages/about.html">About</a> ·
      <a href="/pages/privacy.html">Privacy</a> ·
      <a href="/pages/contact.html">Contact</a>
    </div>
  </div>

  <script>
    // From your existing page :contentReference[oaicite:0]{index=0} (expanded with modes + online)
    const texts = [
      "Systems behave perfectly until humans decide to test them.",
      "A clean interface is a lie told politely to chaos.",
      "Stability is not calm. It is maintenance done on time.",
      "Type fast, think faster, and do not trust the first draft.",
      "The machine is consistent. The operator is the variable.",
      "Speed is a skill. Accuracy is a choice. Pick both."
    ];

    const $ = (id) => document.getElementById(id);

    const state = {
      target: "",
      started: false,
      startAt: 0,
      raf: 0,
      done: false,
      best: Number(localStorage.getItem("swn_typerace_best") || "0"),
      mode: "practice",

      // online
      ws: null,
      online: { connected:false, id:null, room:null, started:false, startAt:0, players:{} }
    };

    function pickText(forceText){
      state.target = forceText || texts[Math.floor(Math.random() * texts.length)];
      renderText("");
      $("raceInput").value = "";
      $("raceFill").style.width = "0%";
      $("raceTime").textContent = "Time: 0.0s";
      $("raceWpm").textContent = "WPM: 0";
      $("raceAcc").textContent = "Acc: 100%";
      $("raceHint").textContent = "Press Start, then type. Timer begins on first keystroke.";
      state.started = false;
      state.done = false;
      cancelAnimationFrame(state.raf);

      // Solo text change should not desync online; online text comes from server.
      if (state.mode.startsWith("online_")) {
        $("raceHint").textContent = "Online mode: wait for server start.";
      }
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function renderText(typed){
      const t = state.target;
      let html = "";
      for (let i = 0; i < t.length; i++){
        const ch = t[i];
        const u = typed[i];
        if (u === undefined) html += `<span class="todo">${escapeHtml(ch)}</span>`;
        else if (u === ch) html += `<span class="ok">${escapeHtml(ch)}</span>`;
        else html += `<span class="bad">${escapeHtml(ch)}</span>`;
      }
      $("raceText").innerHTML = html;
    }

    function metrics(typed, elapsedSec){
      const t = state.target;
      let correct = 0;
      for (let i = 0; i < typed.length; i++) if (typed[i] === t[i]) correct++;
      const acc = typed.length ? (correct / typed.length) : 1;
      const minutes = Math.max(elapsedSec / 60, 1/6000);
      const wpm = Math.max(0, Math.round((correct / 5) / minutes));
      const progress = Math.min(1, typed.length / t.length);
      return { acc, wpm, progress, correct };
    }

    function tick(){
      if (!state.started || state.done) return;
      const now = performance.now();
      const elapsed = (now - state.startAt) / 1000;
      $("raceTime").textContent = `Time: ${elapsed.toFixed(1)}s`;

      const typed = $("raceInput").value;
      const { acc, wpm, progress } = metrics(typed, elapsed);

      $("raceWpm").textContent = `WPM: ${wpm}`;
      $("raceAcc").textContent = `Acc: ${Math.round(acc * 100)}%`;
      $("raceFill").style.width = `${Math.round(progress * 100)}%`;

      state.raf = requestAnimationFrame(tick);
    }

    function updateBest(){
      $("raceBest").textContent = state.best ? `Best: ${state.best} WPM` : "Best: –";
    }

    function setModeUI(){
      state.mode = $("mode").value;
      const online = state.mode.startsWith("online_");
      $("onlineControls").style.display = online ? "" : "none";

      // In online mode, disable local New text (server-controlled)
      $("raceNew").disabled = online;
      $("raceStart").disabled = online; // start controlled by server (on first key after start signal)
      if (online) $("raceHint").textContent = "Online mode: join, then wait for server start.";
      else $("raceHint").textContent = "Press Start, then type. Timer begins on first keystroke.";

      // If leaving online mode while connected, disconnect.
      if (!online && state.ws) onlineLeave();
    }

    // ---------- SOLO INPUT HANDLING ----------
    function soloOnInput(){
      const typed = $("raceInput").value;

      // Instant Death: lose immediately on first mismatch (including extra chars)
      if (state.mode === "instant" && typed.length){
        const i = typed.length - 1;
        if (typed[i] !== state.target[i]) {
          state.done = true;
          state.started = false;
          cancelAnimationFrame(state.raf);
          renderText(typed);
          $("raceHint").textContent = "Instant Death: you lost.";
          return;
        }
      }

      if (!state.started && typed.length){
        state.started = true;
        state.startAt = performance.now();
        cancelAnimationFrame(state.raf);
        state.raf = requestAnimationFrame(tick);
      }

      renderText(typed);

      const elapsed = state.started ? (performance.now() - state.startAt) / 1000 : 0.0001;
      const { wpm, progress } = metrics(typed, elapsed);
      $("raceFill").style.width = `${Math.round(progress * 100)}%`;

      if (!state.done && typed === state.target){
        state.done = true;
        cancelAnimationFrame(state.raf);
        $("raceHint").textContent = "Finished.";
        if (wpm > state.best){
          state.best = wpm;
          localStorage.setItem("swn_typerace_best", String(wpm));
          updateBest();
        }
      }
    }

    // ---------- ONLINE (WEBSOCKET) ----------
    function onlineStatus(s){ $("onlineStatus").textContent = s; }

    function leaderRender(){
      const leader = $("leader");
      leader.innerHTML = "";
      const players = state.online.players || {};
      const ids = Object.keys(players);

      if (!ids.length) return;

      // sort by progress desc
      ids.sort((a,b)=> (players[b].progress||0) - (players[a].progress||0));

      for (const id of ids){
        const p = players[id];
        const row = document.createElement("div");
        row.className = "pRow";

        const tag = document.createElement("div");
        tag.className = "pTag";
        tag.textContent = (id === state.online.id ? "You" : (p.nick || "Racer")) + ` • ${Math.round((p.progress||0)*100)}%`;

        const bar = document.createElement("div");
        bar.className = "pBar";
        const fill = document.createElement("div");
        fill.style.width = `${Math.round((p.progress||0)*100)}%`;
        bar.appendChild(fill);

        row.appendChild(tag);
        row.appendChild(bar);
        leader.appendChild(row);
      }
    }

    function wsUrlFromInput(){
  return "wss://typeracer-ws.cloudflare-handprint600.workers.dev/ws";
}


    function onlineJoin(){
      const url = wsUrlFromInput();
      const mode = state.mode;
      const nick = $("nick").value.trim();
      const room = $("room").value.trim();

      const qs = new URLSearchParams();
qs.set("mode", mode === "online_random" ? "random" : "friends");

if (nick) qs.set("nick", nick);

if (mode === "online_friends") {
  const code = room.trim();
if (!code) {
  alert("Room code required");
  return;
}

  qs.set("room", code);
  qs.set("code", code); // compatibility
  qs.set("id", code);   // compatibility
}


      const ws = new WebSocket(`${url}?${qs.toString()}`);
      state.ws = ws;

      $("onlineJoin").disabled = true;
      $("onlineLeave").disabled = false;
      onlineStatus("Connecting…");

      ws.onopen = () => {
        state.online.connected = true;
        onlineStatus("Connected");
      };

      ws.onclose = () => {
        state.online = { connected:false, id:null, room:null, started:false, startAt:0, players:{} };
        state.ws = null;
        $("onlineJoin").disabled = false;
        $("onlineLeave").disabled = true;
        onlineStatus("Offline");
        $("raceHint").textContent = "Online mode: disconnected.";
        leaderRender();
      };

      ws.onerror = () => {
        onlineStatus("Error");
      };

      ws.onmessage = (ev) => {
        let msg = null;
        try { msg = JSON.parse(ev.data); } catch { return; }

        if (msg.t === "hello"){
          state.online.id = msg.id;
          state.online.room = msg.room;
          if (state.mode === "online_friends") $("room").value = msg.room || $("room").value;
          $("raceHint").textContent = msg.room ? `Room: ${msg.room} • Waiting…` : "Waiting…";
          return;
        }

        if (msg.t === "start"){
          // server provides text + synchronized start time
          state.target = msg.text || state.target;
          renderText("");
          $("raceInput").value = "";
          $("raceFill").style.width = "0%";

          state.done = false;
          state.started = false; // start timer on first local keypress after start
          state.online.started = true;
          state.online.startAt = msg.startAt || Date.now();

          $("raceHint").textContent = "Online: go.";
          return;
        }

        if (msg.t === "players"){
          state.online.players = msg.players || {};
          leaderRender();
          return;
        }

        if (msg.t === "done"){
          $("raceHint").textContent = (msg.winnerId === state.online.id) ? "Online: you won." : "Online: you lost.";
          state.done = true;
          state.started = false;
          cancelAnimationFrame(state.raf);
          return;
        }

        if (msg.t === "kick"){
          try { ws.close(); } catch {}
          return;
        }
      };
    }

    function onlineLeave(){
      if (!state.ws) return;
      try { state.ws.send(JSON.stringify({ t:"leave" })); } catch {}
      try { state.ws.close(); } catch {}
    }

    function onlineSendProgress(typed){
      if (!state.ws || state.ws.readyState !== 1) return;
      const now = Date.now();
      const elapsed = state.online.started ? Math.max(0, (now - state.online.startAt)/1000) : 0.0001;
      const { progress, acc, wpm } = metrics(typed, elapsed);
      try {
        state.ws.send(JSON.stringify({ t:"prog", progress, acc, wpm, len: typed.length }));
      } catch {}
    }

    function onlineOnInput(){
      const typed = $("raceInput").value;

      // Do nothing until server started the race
      if (!state.online.started){
        $("raceInput").value = "";
        return;
      }

      // Online Instant Death behavior is handled server-side by progress checks (client still highlights)
      if (!state.started && typed.length){
        state.started = true;
        state.startAt = performance.now();
        cancelAnimationFrame(state.raf);
        state.raf = requestAnimationFrame(tick);
      }

      renderText(typed);

      const elapsed = state.started ? (performance.now() - state.startAt) / 1000 : 0.0001;
      const { progress } = metrics(typed, elapsed);
      $("raceFill").style.width = `${Math.round(progress * 100)}%`;

      onlineSendProgress(typed);

      if (!state.done && typed === state.target){
        // Let server decide winner; still stop local timer.
        state.done = true;
        cancelAnimationFrame(state.raf);
        $("raceHint").textContent = "Online: finished (waiting).";
        try { state.ws.send(JSON.stringify({ t:"finish" })); } catch {}
      }
    }

    // ---------- BUTTON WIRING ----------
    $("raceNew").onclick = () => pickText();
    $("raceStart").onclick = () => { $("raceInput").focus(); $("raceHint").textContent = "Typing…"; };
    $("raceReset").onclick = () => { pickText(); updateBest(); };

    $("mode").onchange = setModeUI;
    $("onlineJoin").onclick = onlineJoin;
    $("onlineLeave").onclick = onlineLeave;

    $("raceInput").addEventListener("input", () => {
      if (state.mode.startsWith("online_")) onlineOnInput();
      else soloOnInput();
    });

    // init
   
    setModeUI();
    pickText();
    updateBest();
  </script>

  <script type="module">
    import { injectTopbar, injectChatWidget } from "/assets/js/app.js";
    injectTopbar("race");
    injectChatWidget();
  </script>
</body>
</html>
