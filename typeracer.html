<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Type Racer — SureWhyNot</title>
  <link rel="stylesheet" href="/assets/site.css">
  <style>
    /* page-specific */
    .racegrid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
      padding:22px 0 26px;
    }
    @media (max-width: 900px){ .racegrid{grid-template-columns:1fr} }

    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 10px}
    button{
      appearance:none;
      border:1px solid rgba(23,36,59,.85);
      background: linear-gradient(to bottom, rgba(11,21,40,.85), rgba(11,21,40,.55));
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-family:inherit;
      cursor:pointer;
      font-size:13px;
    }
    button:hover{background: linear-gradient(to bottom, rgba(12,25,49,.9), rgba(12,25,49,.55))}
    button.primary{border-color: rgba(246,195,74,.55)}
    button:disabled{opacity:.55; cursor:not-allowed}

    .track{
      border:1px solid rgba(23,36,59,.85);
      border-radius:14px;
      background: rgba(10,15,24,.35);
      padding:12px;
      overflow:hidden;
      position:relative;
      height:240px;
    }
    .lane{
      position:relative;
      height:52px;
      border-bottom:1px dashed rgba(23,36,59,.55);
      display:flex;
      align-items:center;
      padding-left:8px;
    }
    .lane:last-child{border-bottom:none}
    .runner{
      position:absolute;
      left:8px;
      display:flex;
      align-items:center;
      gap:10px;
      transform: translateX(0);
      transition: transform 120ms linear;
      will-change: transform;
    }
    .badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(23,36,59,.85);
      background: rgba(11,21,40,.75);
      padding:4px 8px;
      border-radius:999px;
    }

    /* “objects” (no emoji) */
    .obj{
      width:28px;height:18px;
      border-radius:6px;
      border:1px solid rgba(23,36,59,.85);
      background: rgba(246,195,74,.18);
      position:relative;
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
    }
    .obj::after{
      content:"";
      position:absolute;
      right:-6px; top:6px;
      width:8px;height:6px;
      border-radius:0 6px 6px 0;
      background: rgba(246,195,74,.35);
      border:1px solid rgba(23,36,59,.85);
    }
    .obj.car{border-radius:7px}
    .obj.plane{clip-path: polygon(0 50%, 25% 20%, 70% 20%, 100% 50%, 70% 80%, 25% 80%)}
    .obj.ele{width:30px;height:20px;border-radius:10px}
    .obj.ant{width:22px;height:14px;border-radius:999px}

    .finish{
      position:absolute;
      right:10px;
      top:12px;
      bottom:12px;
      width:10px;
      border-radius:8px;
      background: repeating-linear-gradient(
        to bottom,
        rgba(246,195,74,.85) 0px,
        rgba(246,195,74,.85) 10px,
        rgba(246,195,74,.15) 10px,
        rgba(246,195,74,.15) 20px
      );
      opacity:.9;
    }

    textarea{
      width:100%;
      min-height:86px;
      resize:vertical;
      border-radius:12px;
      border:1px solid rgba(23,36,59,.85);
      background: rgba(11,21,40,.45);
      color:var(--text);
      padding:12px;
      font-family:inherit;
      font-size:13px;
      outline:none;
    }
    textarea:disabled{opacity:.55}

    .statrow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .stat{
      border:1px solid rgba(23,36,59,.85);
      background: rgba(11,21,40,.35);
      border-radius:12px;
      padding:10px;
      font-size:12px;
      color:var(--muted);
    }
    .stat b{display:block; color:var(--text); font-size:14px; margin-top:2px}

    .lobbybox{
      border:1px solid rgba(23,36,59,.85);
      background: rgba(11,21,40,.35);
      border-radius:12px;
      padding:12px;
      margin-top:10px;
      font-size:12.5px;
      color:var(--muted);
      line-height:1.5;
    }
    .lobbylist{margin:8px 0 0; padding-left:18px}
    .tiny{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
  <div class="page">
    <div id="site-header"></div>

    <main>
      <div class="wrap">
        <section class="racegrid">
          <div class="card">
            <div class="pad">
              <div class="h1">Race the car, elephant, airplane, and ant</div>
              <div class="muted">Click <span class="kbd">Enter Race</span>. Wait for the lobby. Race starts when the timer hits zero.</div>

              <div class="btnrow">
                <button class="primary" id="btnEnter">Enter Race</button>
                <button id="btnNew" disabled>New Race</button>
              </div>

              <div class="track" aria-label="Race track">
                <div class="finish" aria-hidden="true"></div>

                <div class="lane">
                  <div class="runner" id="rYou">
                    <div class="obj car" title="car"></div>
                    <span class="badge">You</span>
                  </div>
                </div>

                <div class="lane">
                  <div class="runner" id="rEle">
                    <div class="obj ele" title="elephant"></div>
                    <span class="badge">Elephant</span>
                  </div>
                </div>

                <div class="lane">
                  <div class="runner" id="rPlane">
                    <div class="obj plane" title="airplane"></div>
                    <span class="badge">Airplane</span>
                  </div>
                </div>

                <div class="lane">
                  <div class="runner" id="rAnt">
                    <div class="obj ant" title="ant"></div>
                    <span class="badge">Ant</span>
                  </div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="muted" id="raceText"></div>
              <textarea id="input" placeholder="Type here when the race begins…" disabled></textarea>

              <div class="statrow">
                <div class="stat">WPM <b id="wpm">0</b></div>
                <div class="stat">Accuracy <b id="acc">100%</b></div>
                <div class="stat">Time <b id="time">0.0s</b></div>
              </div>

              <div class="lobbybox" id="lobbyBox">
                <div><b style="color:var(--text)">Lobby</b></div>
                <div class="tiny" id="lobbyStatus">Not in a race.</div>
                <ul class="lobbylist" id="lobbyList"></ul>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="pad">
              <div class="h1">Ad slot placeholder</div>
              <div class="adslot">
                <div style="font-size:12px;color:var(--muted);margin-bottom:10px;">
                  Keep this spot consistent so the layout doesn’t jump later.
                </div>
                <b>[ AdSense Slot Here ]</b>
              </div>

              <div class="hr"></div>

              <div class="h1" style="margin-top:0">How it works</div>
              <div class="muted">
                - Your object moves based on correct characters typed.<br>
                - Others move at steady speeds.<br>
                - Race text is 4 sentences so it feels worth it.<br>
                - Lobby uses same-device tabs (and bots if you’re alone).
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer>
      <div class="footerwrap">
        <div>© 2026 surewhynot.app</div>
        <div class="footerlinks">
          <a href="/about.html">About</a>
          <span>•</span>
          <a href="/privacy.html">Privacy</a>
          <span>•</span>
          <a href="/contact.html">Contact</a>
        </div>
      </div>
    </footer>
  </div>

<script>
(() => {
  // ====== Race text (4 sentences) ======
  const TEXT = [
    "A quiet site can still feel alive when people choose to play.",
    "Type steady and keep your eyes on the next word, not the finish line.",
    "Speed comes from calm hands and clean rhythm, not panic.",
    "Finish clean, and the race ends when your last character lands."
  ].join(" ");

  const elRaceText = document.getElementById("raceText");
  const input = document.getElementById("input");
  const btnEnter = document.getElementById("btnEnter");
  const btnNew = document.getElementById("btnNew");

  const wpmEl = document.getElementById("wpm");
  const accEl = document.getElementById("acc");
  const timeEl = document.getElementById("time");

  const lobbyStatus = document.getElementById("lobbyStatus");
  const lobbyList = document.getElementById("lobbyList");

  const rYou = document.getElementById("rYou");
  const rEle = document.getElementById("rEle");
  const rPlane = document.getElementById("rPlane");
  const rAnt = document.getElementById("rAnt");

  elRaceText.textContent = TEXT;

  // ====== Lobby (same-device tabs) ======
  // Open multiple browser tabs to surewhynot.app/typeracer.html to simulate real people.
  const channel = new BroadcastChannel("surewhynot-typeracer-lobby");
  const myId = crypto.randomUUID().slice(0, 8);
  const myName = "Guest-" + myId;

  let lobby = new Map(); // id -> name
  let inLobby = false;
  let countdown = 0;
  let countdownTimer = null;

  // ====== Race state ======
  let startedAt = null;
  let finished = false;
  let lastTick = null;

  const botSpeeds = { ele: 0.55, plane: 0.75, ant: 0.35 }; // chars per 100ms-ish
  let botProgress = { ele: 0, plane: 0, ant: 0 };

  let youCorrect = 0;
  let youTotal = 0;

  function renderLobby() {
    lobbyList.innerHTML = "";
    const names = Array.from(lobby.values());
    names.forEach(n => {
      const li = document.createElement("li");
      li.textContent = n;
      lobbyList.appendChild(li);
    });
  }

  function setLobbyStatus(text) {
    lobbyStatus.textContent = text;
  }

  function resetTrack() {
    // 0..1 progress -> pixels
    setRunner(rYou, 0);
    setRunner(rEle, 0);
    setRunner(rPlane, 0);
    setRunner(rAnt, 0);
  }

  function setRunner(el, progress01) {
    const track = document.querySelector(".track");
    const lanePaddingLeft = 8;
    const finishPaddingRight = 22; // leave room near finish bar
    const max = track.clientWidth - lanePaddingLeft - finishPaddingRight;
    const x = Math.max(0, Math.min(1, progress01)) * max;
    el.style.transform = `translateX(${x}px)`;
  }

  function charsDoneToProgress(charsDone) {
    return charsDone / TEXT.length;
  }

  function calcWPM(charsCorrect, seconds) {
    // WPM = (chars/5) / minutes
    if (seconds <= 0) return 0;
    const words = charsCorrect / 5;
    const minutes = seconds / 60;
    return Math.round(words / minutes);
  }

  function updateStats() {
    const seconds = startedAt ? (performance.now() - startedAt) / 1000 : 0;
    timeEl.textContent = seconds.toFixed(1) + "s";
    wpmEl.textContent = calcWPM(youCorrect, seconds);
    const acc = youTotal ? Math.round((youCorrect / youTotal) * 100) : 100;
    accEl.textContent = acc + "%";
  }

  function startCountdown() {
    countdown = 30;
    btnEnter.disabled = true;
    btnNew.disabled = true;
    input.disabled = true;
    input.value = "";
    youCorrect = 0;
    youTotal = 0;
    botProgress = { ele: 0, plane: 0, ant: 0 };
    finished = false;
    startedAt = null;
    lastTick = null;
    resetTrack();
    updateStats();

    setLobbyStatus(`In lobby. Race starts in ${countdown}s…`);

    if (countdownTimer) clearInterval(countdownTimer);
    countdownTimer = setInterval(() => {
      countdown--;
      if (countdown > 0) {
        setLobbyStatus(`In lobby. Race starts in ${countdown}s…`);
        // if you're alone, add 2 bots early so the lobby doesn't feel empty
        ensureBotsIfAlone();
        renderLobby();
        return;
      }
      clearInterval(countdownTimer);
      countdownTimer = null;
      beginRace();
    }, 1000);
  }

  function ensureBotsIfAlone() {
    // If only 1 real player in lobby, add 2 bot “players”
    const realCount = Array.from(lobby.keys()).filter(id => !id.startsWith("bot-")).length;
    if (realCount <= 1) {
      if (!lobby.has("bot-ele")) lobby.set("bot-ele", "Elephant (bot)");
      if (!lobby.has("bot-plane")) lobby.set("bot-plane", "Airplane (bot)");
      if (!lobby.has("bot-ant")) lobby.set("bot-ant", "Ant (bot)");
    }
  }

  function beginRace() {
    setLobbyStatus("Race started. Type now.");
    startedAt = performance.now();
    input.disabled = false;
    input.focus();
    btnNew.disabled = false;

    requestAnimationFrame(tick);
  }

  function tick(ts) {
    if (!startedAt || finished) return;

    if (lastTick == null) lastTick = ts;
    const dt = ts - lastTick;
    lastTick = ts;

    // bots move steadily
    botProgress.ele += (botSpeeds.ele * dt) / 100;
    botProgress.plane += (botSpeeds.plane * dt) / 100;
    botProgress.ant += (botSpeeds.ant * dt) / 100;

    setRunner(rEle, charsDoneToProgress(botProgress.ele));
    setRunner(rPlane, charsDoneToProgress(botProgress.plane));
    setRunner(rAnt, charsDoneToProgress(botProgress.ant));

    updateStats();

    // finish checks
    const youP = charsDoneToProgress(youCorrect);
    if (youP >= 1) {
      finished = true;
      input.disabled = true;
      setLobbyStatus("Finished. Click New Race to queue again.");
      // tell lobby you left
      leaveLobby();
      return;
    }

    requestAnimationFrame(tick);
  }

  function computeCorrectChars(typed) {
    // count correct chars from start until mismatch
    const max = Math.min(typed.length, TEXT.length);
    let correct = 0;
    for (let i = 0; i < max; i++) {
      if (typed[i] === TEXT[i]) correct++;
      else break;
    }
    return correct;
  }

  input.addEventListener("input", () => {
    if (!startedAt || finished) return;

    const typed = input.value;
    youTotal = typed.length;
    youCorrect = computeCorrectChars(typed);

    const p = charsDoneToProgress(youCorrect);
    setRunner(rYou, p);

    // lock extra typing after full length
    if (typed.length > TEXT.length) {
      input.value = typed.slice(0, TEXT.length);
    }
  });

  // ====== BroadcastChannel messages ======
  channel.onmessage = (ev) => {
    const msg = ev.data || {};
    if (msg.type === "join") {
      lobby.set(msg.id, msg.name);
      renderLobby();
    }
    if (msg.type === "leave") {
      lobby.delete(msg.id);
      renderLobby();
    }
    if (msg.type === "sync" && inLobby) {
      // someone asked for roster
      channel.postMessage({ type: "roster", to: msg.from, roster: Array.from(lobby.entries()) });
    }
    if (msg.type === "roster" && msg.to === myId) {
      // merge roster
      msg.roster.forEach(([id, name]) => lobby.set(id, name));
      renderLobby();
    }
  };

  function joinLobby() {
    lobby.clear();
    lobby.set(myId, myName);
    inLobby = true;
    channel.postMessage({ type: "join", id: myId, name: myName });
    channel.postMessage({ type: "sync", from: myId }); // ask others to send roster
    ensureBotsIfAlone();
    renderLobby();
  }

  function leaveLobby() {
    if (!inLobby) return;
    inLobby = false;
    channel.postMessage({ type: "leave", id: myId });
    lobby.clear();
    renderLobby();
  }

  // ====== Buttons ======
  btnEnter.addEventListener("click", () => {
    joinLobby();
    startCountdown();
  });

  btnNew.addEventListener("click", () => {
    // "New Race" refreshes the lobby (no reset button)
    leaveLobby();
    joinLobby();
    startCountdown();
  });

  // on page close, leave
  window.addEventListener("beforeunload", () => {
    leaveLobby();
  });

  // initial
  resetTrack();
  renderLobby();
})();
</script>
</body>
</html>
