<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Type Racer — SureWhyNot</title>
  <link rel="stylesheet" href="/assets/site.css">

  <style>
    .racegrid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
      padding:22px 0 26px;
    }
    @media (max-width: 900px){ .racegrid{grid-template-columns:1fr} }

    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 10px}
    button{
      appearance:none;
      border:1px solid rgba(23,36,59,.85);
      background: linear-gradient(to bottom, rgba(11,21,40,.85), rgba(11,21,40,.55));
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-family:inherit;
      cursor:pointer;
      font-size:13px;
    }
    button:hover{background: linear-gradient(to bottom, rgba(12,25,49,.9), rgba(12,25,49,.55))}
    button.primary{border-color: rgba(246,195,74,.55)}
    button:disabled{opacity:.55; cursor:not-allowed}

    .track{
      border:1px solid rgba(23,36,59,.85);
      border-radius:14px;
      background: rgba(10,15,24,.35);
      padding:12px;
      overflow:hidden;
      position:relative;
      height:220px;
    }
    .lane{
      position:relative;
      height:50px;
      border-bottom:1px dashed rgba(23,36,59,.55);
      display:flex;
      align-items:center;
      padding-left:8px;
    }
    .lane:last-child{border-bottom:none}

    .runner{
      position:absolute;
      left:8px;
      display:flex;
      align-items:center;
      gap:10px;
      transform: translateX(0);
      transition: transform 120ms linear;
      will-change: transform;
    }
    .badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(23,36,59,.85);
      background: rgba(11,21,40,.75);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }

    .finish{
      position:absolute;
      right:10px;
      top:12px;
      bottom:12px;
      width:10px;
      border-radius:8px;
      background: repeating-linear-gradient(
        to bottom,
        rgba(246,195,74,.85) 0px,
        rgba(246,195,74,.85) 10px,
        rgba(246,195,74,.15) 10px,
        rgba(246,195,74,.15) 20px
      );
      opacity:.9;
    }

    textarea{
      width:100%;
      min-height:86px;
      resize:vertical;
      border-radius:12px;
      border:1px solid rgba(23,36,59,.85);
      background: rgba(11,21,40,.45);
      color:var(--text);
      padding:12px;
      font-family:inherit;
      font-size:13px;
      outline:none;
    }
    textarea:disabled{opacity:.55}

    .statrow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .stat{
      border:1px solid rgba(23,36,59,.85);
      background: rgba(11,21,40,.35);
      border-radius:12px;
      padding:10px;
      font-size:12px;
      color:var(--muted);
    }
    .stat b{display:block; color:var(--text); font-size:14px; margin-top:2px}

    .lobbybox{
      border:1px solid rgba(23,36,59,.85);
      background: rgba(11,21,40,.35);
      border-radius:12px;
      padding:12px;
      margin-top:10px;
      font-size:12.5px;
      color:var(--muted);
      line-height:1.5;
    }
    .lobbylist{margin:8px 0 0; padding-left:18px}
    .tiny{font-size:12px;color:var(--muted)}

    /* ===== Unified SVG icon style ===== */
    .veh{
      width:46px;
      height:28px;
      display:inline-grid;
      place-items:center;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.40));
    }
    .veh svg{ width:46px; height:28px; display:block; }
    .veh .stroke{ stroke: rgba(0,0,0,.55); stroke-width: 1.2; stroke-linecap: round; stroke-linejoin: round; }
    .veh .glass{ fill: rgba(120,220,255,.35); }
    .veh .tire{ fill:#141414; }
    .veh .rim{ fill:#a9a9a9; }
	.veh .rim{ fill:#a9a9a9; }

    /* Rotate airplane 90° clockwise */
    .veh.plane svg {
    transform: rotate(90deg);
    transform-origin: center; }

  </style>
</head>

<script>
async function loadPartials() {
  const header = await fetch('/partials/header.html');
  const footer = await fetch('/partials/footer.html');

  document.getElementById('site-header').innerHTML = await header.text();
  document.getElementById('site-footer').innerHTML = await footer.text();

  if (window.SWY_renderToolUse) window.SWY_renderToolUse();
}
loadPartials();
</script>

<body>
  <div class="page">
    <div id="site-header"></div>

    <main>
      <div class="wrap">
        <section class="racegrid">
          <div class="card">
            <div class="pad">
              <div class="h1">Type Racer</div>
              <div class="muted">
                Join lobby to find a real match. If nobody joins by the end of the timer, no race starts — you can leave and practice solo or try again.
              </div>

              <div class="btnrow">
                <button class="primary" id="btnEnter">Join Lobby</button>
                <button id="btnPractice">Practice Solo</button>
                <button id="btnLeave" disabled>Leave</button>
                <button id="btnNew" disabled>Try Again</button>
              </div>

              <div class="track" aria-label="Race track">
                <div class="finish" aria-hidden="true"></div>

                <div class="lane">
                  <div class="runner" id="r1">
                    <div class="veh truck" title="monster truck" aria-label="monster truck">
                      <svg viewBox="0 0 46 28" role="img" aria-hidden="true">
                        <defs>
                          <linearGradient id="gradTruck" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0" stop-color="#31d18b"/><stop offset="1" stop-color="#157a57"/>
                          </linearGradient>
                          <linearGradient id="metalTruck" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0" stop-color="rgba(255,255,255,.22)"/><stop offset="1" stop-color="rgba(0,0,0,.22)"/>
                          </linearGradient>
                        </defs>

                        <circle cx="12" cy="22" r="5.6" class="tire"/>
                        <circle cx="34" cy="22" r="5.6" class="tire"/>
                        <circle cx="12" cy="22" r="2.5" class="rim"/>
                        <circle cx="34" cy="22" r="2.5" class="rim"/>

                        <path d="M7 18 L10 12 Q12 9 16 9 L22 9 L26 12 L38 12 Q41 12 42 15 L42 18 Z" fill="url(#gradTruck)"/>
                        <path d="M10 12 Q12 10 15 10 L21 10 L24 12 Z" fill="url(#metalTruck)"/>
                        <rect x="17.5" y="10.5" width="6.5" height="4.2" rx="1.4" class="glass"/>

                        <path d="M7 18 L10 12 Q12 9 16 9 L22 9 L26 12 L38 12 Q41 12 42 15 L42 18 Z" class="stroke" fill="none"/>
                        <path d="M9 18 L41 18" class="stroke" fill="none"/>
                      </svg>
                    </div>
                    <span class="badge" id="n1">You</span>
                  </div>
                </div>

                <div class="lane">
                  <div class="runner" id="r2">
                    <div class="veh plane" title="airplane" aria-label="airplane">
                      <svg viewBox="0 0 46 28" role="img" aria-hidden="true">
                        <defs>
                          <linearGradient id="gradPlane" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0" stop-color="#6cc7ff"/><stop offset="1" stop-color="#2457c6"/>
                          </linearGradient>
                          <linearGradient id="metalPlane" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0" stop-color="rgba(255,255,255,.26)"/><stop offset="1" stop-color="rgba(0,0,0,.20)"/>
                          </linearGradient>
                        </defs>

                        <!-- Top-ish view -->
                        <path d="M8 15 L20 13 L20 17 Z" fill="url(#gradPlane)"/>
                        <path d="M38 15 L26 13 L26 17 Z" fill="url(#gradPlane)"/>
                        <path d="M22 4 Q23 3 24 4 L26 7 L26 21 L24 24 Q23 25 22 24 L20 21 L20 7 Z" fill="url(#metalPlane)"/>
                        <path d="M21.5 6 L24.5 6 L25.3 8 L20.7 8 Z" fill="url(#gradPlane)"/>
                        <path d="M20 20 L23 18 L26 20 L23 22 Z" fill="url(#gradPlane)"/>

                        <path d="M8 15 L20 13 L20 17 Z" class="stroke" fill="none"/>
                        <path d="M38 15 L26 13 L26 17 Z" class="stroke" fill="none"/>
                        <path d="M22 4 Q23 3 24 4 L26 7 L26 21 L24 24 Q23 25 22 24 L20 21 L20 7 Z" class="stroke" fill="none"/>
                        <path d="M20 20 L23 18 L26 20 L23 22 Z" class="stroke" fill="none"/>
                      </svg>
                    </div>
                    <span class="badge" id="n2">Waiting…</span>
                  </div>
                </div>

                <div class="lane">
                  <div class="runner" id="r3">
                    <div class="veh f1" title="formula 1" aria-label="formula 1 car">
                      <svg viewBox="0 0 46 28" role="img" aria-hidden="true">
                        <defs>
                          <linearGradient id="gradF1" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0" stop-color="#ff4b4b"/><stop offset="1" stop-color="#8b1010"/>
                          </linearGradient>
                          <linearGradient id="metalF1" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0" stop-color="rgba(255,255,255,.22)"/><stop offset="1" stop-color="rgba(0,0,0,.24)"/>
                          </linearGradient>
                        </defs>

                        <circle cx="12" cy="21.5" r="5.0" class="tire"/>
                        <circle cx="34" cy="21.5" r="5.0" class="tire"/>
                        <circle cx="12" cy="21.5" r="2.2" class="rim"/>
                        <circle cx="34" cy="21.5" r="2.2" class="rim"/>

                        <path d="M6 18 L12 15 L19 14 L28 14 L36 15 L42 18 L42 19 L6 19 Z" fill="url(#gradF1)"/>
                        <path d="M12 15 L18 10 Q19 9 21 9 L25 9 Q27 9 28 10 L32 14 Z" fill="url(#metalF1)"/>
                        <rect x="21" y="10.5" width="6" height="3.5" rx="1.2" class="glass"/>

                        <rect x="5.2" y="17.4" width="6" height="2.6" rx="1.0" fill="rgba(255,255,255,.10)"/>
                        <rect x="34.8" y="17.4" width="6" height="2.6" rx="1.0" fill="rgba(255,255,255,.10)"/>

                        <path d="M6 18 L12 15 L19 14 L28 14 L36 15 L42 18 L42 19 L6 19 Z" class="stroke" fill="none"/>
                        <path d="M12 15 L18 10 Q19 9 21 9 L25 9 Q27 9 28 10 L32 14 Z" class="stroke" fill="none"/>
                      </svg>
                    </div>
                    <span class="badge" id="n3">Waiting…</span>
                  </div>
                </div>

                <div class="lane">
                  <div class="runner" id="r4">
                    <div class="veh boat" title="boat" aria-label="boat">
                      <svg viewBox="0 0 46 28" role="img" aria-hidden="true">
                        <defs>
                          <linearGradient id="gradBoat" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0" stop-color="#ffd166"/><stop offset="1" stop-color="#b65d00"/>
                          </linearGradient>
                          <linearGradient id="metalBoat" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0" stop-color="rgba(255,255,255,.22)"/><stop offset="1" stop-color="rgba(0,0,0,.26)"/>
                          </linearGradient>
                        </defs>

                        <path d="M23 6 L23 19 L14 19 Z" fill="url(#metalBoat)"/>
                        <path d="M23 6 L33 18 L23 18 Z" fill="url(#gradBoat)"/>
                        <rect x="22.3" y="6" width="1.4" height="14" rx="0.7" fill="rgba(0,0,0,.35)"/>

                        <path d="M8 19 L38 19 Q36 24 23 25 Q10 24 8 19 Z" fill="url(#gradBoat)"/>
                        <path d="M10 20 Q23 22 36 20 Q34 23 23 24 Q12 23 10 20 Z" fill="rgba(255,255,255,.10)"/>

                        <path d="M8 19 L38 19 Q36 24 23 25 Q10 24 8 19 Z" class="stroke" fill="none"/>
                        <path d="M23 6 L23 19 L14 19 Z" class="stroke" fill="none"/>
                        <path d="M23 6 L33 18 L23 18 Z" class="stroke" fill="none"/>
                      </svg>
                    </div>
                    <span class="badge" id="n4">Waiting…</span>
                  </div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="muted" id="raceText"></div>
              <textarea id="input" placeholder="Type here when the race begins…" disabled></textarea>

              <div class="statrow">
                <div class="stat">WPM <b id="wpm">0</b></div>
                <div class="stat">Accuracy <b id="acc">100%</b></div>
                <div class="stat">Time <b id="time">0.0s</b></div>
              </div>

              <div class="lobbybox" id="lobbyBox">
                <div><b style="color:var(--text)">Lobby</b></div>
                <div class="tiny" id="lobbyStatus">Not in a lobby.</div>
                <ul class="lobbylist" id="lobbyList"></ul>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="pad">
              <div class="h1">How it works</div>
              <div class="muted">
                - Lobby match timer runs when you join.<br>
                - Race only starts if 2+ real players are present.<br>
                - Practice mode is always available.<br>
                - Everything runs client-side (same-device tabs only for now).
              </div>

              <div class="hr"></div>

              <div class="adslot">
                <div style="font-size:12px;color:var(--muted);margin-bottom:10px;">
                  Keep this spot consistent so the layout doesn’t jump later.
                </div>
                <b>[ AdSense Slot Here ]</b>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <div id="site-footer"></div>
  </div>

<script>
(() => {
  const TEXT = [
    "Race clean and steady.",
    "Accuracy first, speed second.",
    "One character at a time.",
    "Finish strong."
  ].join(" ");

  const elRaceText = document.getElementById("raceText");
  const input = document.getElementById("input");

  const btnEnter = document.getElementById("btnEnter");
  const btnPractice = document.getElementById("btnPractice");
  const btnLeave = document.getElementById("btnLeave");
  const btnNew = document.getElementById("btnNew");

  const wpmEl = document.getElementById("wpm");
  const accEl = document.getElementById("acc");
  const timeEl = document.getElementById("time");

  const lobbyStatus = document.getElementById("lobbyStatus");
  const lobbyList = document.getElementById("lobbyList");

  const runners = [
    document.getElementById("r1"),
    document.getElementById("r2"),
    document.getElementById("r3"),
    document.getElementById("r4"),
  ];
  const names = [
    document.getElementById("n1"),
    document.getElementById("n2"),
    document.getElementById("n3"),
    document.getElementById("n4"),
  ];

  elRaceText.textContent = TEXT;

  const ADJ = ["Sleepy","Spicy","Quantum","Cranky","Sneaky","Turbo","Glitchy","Wobbly","Moody","Cosmic","Rusty","Chaotic","Polite","Ferocious","Tiny","Big","Nervous","Chill","Saucy","Gremlin"];
  const NOUN = ["Nginx","Kernel","Panda","Router","Yeti","Byte","Packet","Goblin","Octopus","Unicorn","Linter","Daemon","Banana","Squirrel","Dragon","Proxy","Hash","Socket","Wombat","Cactus"];
  function randInt(n){
    const a = new Uint32Array(1);
    crypto.getRandomValues(a);
    return a[0] % n;
  }
  function goofyName(){
    return ADJ[randInt(ADJ.length)] + " " + NOUN[randInt(NOUN.length)];
  }

  const channel = new BroadcastChannel("surewhynot-typeracer-lobby-v3");
  const myId = crypto.randomUUID().slice(0, 10);
  const myName = goofyName();

  let lobby = new Map(); // id -> {name, ts}
  let inLobby = false;

  let mode = "idle"; // idle | lobby | practice | race
  let startedAt = null;
  let finished = false;

  let matchTimer = null;
  let matchSecondsLeft = 0;

  let raceCountdownTimer = null;
  let raceCountdownLeft = 0;

  let progress = new Map(); // id -> correct chars

  function setLobbyStatus(text){ lobbyStatus.textContent = text; }

  function renderLobby() {
    lobbyList.innerHTML = "";
    const entries = Array.from(lobby.values()).map(x => x.name).sort();
    entries.forEach(n => {
      const li = document.createElement("li");
      li.textContent = n;
      lobbyList.appendChild(li);
    });
  }

  function setRunner(el, progress01) {
    const track = document.querySelector(".track");
    const lanePaddingLeft = 8;
    const finishPaddingRight = 22;
    const max = track.clientWidth - lanePaddingLeft - finishPaddingRight;
    const x = Math.max(0, Math.min(1, progress01)) * max;
    el.style.transform = `translateX(${x}px)`;
  }

  function resetTrack() {
    runners.forEach(r => setRunner(r, 0));
  }

  function charsDoneToProgress(charsDone){ return charsDone / TEXT.length; }

  function calcWPM(charsCorrect, seconds) {
    if (seconds <= 0) return 0;
    const words = charsCorrect / 5;
    const minutes = seconds / 60;
    return Math.round(words / minutes);
  }

  function computeCorrectChars(typed) {
    const max = Math.min(typed.length, TEXT.length);
    let correct = 0;
    for (let i = 0; i < max; i++) {
      if (typed[i] === TEXT[i]) correct++;
      else break;
    }
    return correct;
  }

  function updateStats(youCorrect, youTotal) {
    const seconds = startedAt ? (performance.now() - startedAt) / 1000 : 0;
    timeEl.textContent = seconds.toFixed(1) + "s";
    wpmEl.textContent = calcWPM(youCorrect, seconds);
    const acc = youTotal ? Math.round((youCorrect / youTotal) * 100) : 100;
    accEl.textContent = acc + "%";
  }

  function setButtons() {
    const idle = mode === "idle";
    btnEnter.disabled = !idle;
    btnPractice.disabled = !idle;
    btnLeave.disabled = idle;
    btnNew.disabled = !(mode === "lobby" || mode === "practice" || mode === "race");
  }

  function stopMatchTimer(){
    if(matchTimer) clearInterval(matchTimer);
    matchTimer = null;
    matchSecondsLeft = 0;
  }

  function stopRaceCountdown(){
    if(raceCountdownTimer) clearInterval(raceCountdownTimer);
    raceCountdownTimer = null;
    raceCountdownLeft = 0;
  }

  function realPlayers(){
    return Array.from(lobby.entries()).map(([id,v]) => ({id, name:v.name}));
  }

  function assignLanes(){
    names[0].textContent = myName + " (You)";
    const others = realPlayers().filter(p => p.id !== myId).sort((a,b) => a.id.localeCompare(b.id));

    for(let i=0;i<3;i++){
      names[i+1].textContent = "Waiting…";
      setRunner(runners[i+1], 0);
    }

    for(let i=0;i<Math.min(3, others.length);i++){
      names[i+1].textContent = others[i].name;
    }
  }

  function joinLobby() {
    stopMatchTimer();
    stopRaceCountdown();
    progress.clear();
    resetTrack();

    lobby.clear();
    lobby.set(myId, { name: myName, ts: Date.now() });
    inLobby = true;
    mode = "lobby";
    setButtons();

    channel.postMessage({ type: "join", id: myId, name: myName, ts: Date.now() });
    channel.postMessage({ type: "sync", from: myId });

    input.disabled = true;
    input.value = "";
    finished = false;
    startedAt = null;

    renderLobby();
    assignLanes();
    updateStats(0,0);

    matchSecondsLeft = 15;
    setLobbyStatus(`Searching… (${matchSecondsLeft}s)`);
    matchTimer = setInterval(() => {
      matchSecondsLeft--;
      if (lobby.size >= 2) {
        stopMatchTimer();
        startRaceCountdownIfReady();
        return;
      }
      if (matchSecondsLeft > 0) {
        setLobbyStatus(`Searching… (${matchSecondsLeft}s)`);
        return;
      }
      stopMatchTimer();
      setLobbyStatus("No match found. Leave, practice solo, or try again.");
    }, 1000);
  }

  function leaveLobby() {
    stopMatchTimer();
    stopRaceCountdown();
    if (inLobby) channel.postMessage({ type: "leave", id: myId });

    inLobby = false;
    lobby.clear();
    progress.clear();
    renderLobby();

    mode = "idle";
    setLobbyStatus("Not in a lobby.");
    input.disabled = true;
    input.value = "";
    finished = false;
    startedAt = null;
    resetTrack();
    assignLanes();
    updateStats(0,0);
    setButtons();
  }

  function startRaceCountdownIfReady(){
    if (mode !== "lobby") return;
    if (lobby.size < 2) return;
    if (raceCountdownTimer) return;

    raceCountdownLeft = 5;
    setLobbyStatus(`Match found. Race starts in ${raceCountdownLeft}s…`);
    channel.postMessage({ type: "countdown", seconds: raceCountdownLeft, ts: Date.now() });

    raceCountdownTimer = setInterval(() => {
      raceCountdownLeft--;
      if (raceCountdownLeft > 0) {
        setLobbyStatus(`Match found. Race starts in ${raceCountdownLeft}s…`);
        channel.postMessage({ type: "countdown", seconds: raceCountdownLeft, ts: Date.now() });
        return;
      }
      stopRaceCountdown();
      const startTs = Date.now() + 200;
      channel.postMessage({ type: "start", startTs, text: TEXT });
      beginRace(startTs);
    }, 1000);
  }

  function beginPractice() {
    leaveLobby();
    mode = "practice";
    setButtons();

    finished = false;
    startedAt = performance.now();
    resetTrack();
    assignLanes();
    updateStats(0,0);

    input.disabled = false;
    input.value = "";
    input.focus();

    setLobbyStatus("Practice mode. Just you.");
  }

  function beginRace(startTs) {
    mode = "race";
    setButtons();

    stopMatchTimer();
    stopRaceCountdown();

    finished = false;
    progress.set(myId, 0);

    resetTrack();
    assignLanes();
    updateStats(0,0);

    input.disabled = true;
    input.value = "";

    const delay = Math.max(0, startTs - Date.now());
    setLobbyStatus("Race starting…");
    setTimeout(() => {
      if (mode !== "race") return;
      startedAt = performance.now();
      input.disabled = false;
      input.focus();
      setLobbyStatus("Race started. Type now.");
      requestAnimationFrame(tickRace);
    }, delay);
  }

  function tickRace() {
    if (mode !== "race" || finished) return;

    assignLanes();

    const players = realPlayers().sort((a,b)=>a.id.localeCompare(b.id));
    const others = players.filter(p => p.id !== myId);

    const youC = progress.get(myId) || 0;
    setRunner(runners[0], charsDoneToProgress(youC));

    for(let i=0;i<3;i++){
      const p = others[i];
      if (!p) { setRunner(runners[i+1], 0); continue; }
      const c = progress.get(p.id) || 0;
      setRunner(runners[i+1], charsDoneToProgress(c));
    }

    if (charsDoneToProgress(youC) >= 1) {
      finishRace();
      return;
    }

    requestAnimationFrame(tickRace);
  }

  function finishRace(){
    finished = true;
    input.disabled = true;

    const youC = progress.get(myId) || 0;
    const youTotal = input.value.length || 0;
    const seconds = startedAt ? (performance.now() - startedAt) / 1000 : 0;
    const finalWpm = calcWPM(youC, seconds);

    if (mode === "practice") setLobbyStatus(`Practice finished. WPM: ${finalWpm}.`);
    else setLobbyStatus(`Finished. WPM: ${finalWpm}.`);
  }

  input.addEventListener("input", () => {
    if (!startedAt || finished) return;

    const typed = input.value;
    const youTotal = typed.length;
    const youCorrect = computeCorrectChars(typed);

    progress.set(myId, youCorrect);
    updateStats(youCorrect, youTotal);
    setRunner(runners[0], charsDoneToProgress(youCorrect));

    if (mode === "race" && inLobby) {
      channel.postMessage({ type: "progress", id: myId, correct: youCorrect, ts: Date.now() });
    }

    if (typed.length > TEXT.length) input.value = typed.slice(0, TEXT.length);
    if (charsDoneToProgress(youCorrect) >= 1) finishRace();
  });

  channel.onmessage = (ev) => {
    const msg = ev.data || {};

    if (msg.type === "join") {
      lobby.set(msg.id, { name: msg.name, ts: msg.ts || Date.now() });
      renderLobby();
      assignLanes();
      if (mode === "lobby" && lobby.size >= 2) {
        stopMatchTimer();
        startRaceCountdownIfReady();
      }
    }

    if (msg.type === "leave") {
      lobby.delete(msg.id);
      progress.delete(msg.id);
      renderLobby();
      assignLanes();

      if (mode === "lobby" && lobby.size < 2) {
        stopRaceCountdown();
        if (!matchTimer) {
          matchSecondsLeft = 10;
          setLobbyStatus(`Searching… (${matchSecondsLeft}s)`);
          matchTimer = setInterval(() => {
            matchSecondsLeft--;
            if (lobby.size >= 2) {
              stopMatchTimer();
              startRaceCountdownIfReady();
              return;
            }
            if (matchSecondsLeft > 0) {
              setLobbyStatus(`Searching… (${matchSecondsLeft}s)`);
              return;
            }
            stopMatchTimer();
            setLobbyStatus("No match found. Leave, practice solo, or try again.");
          }, 1000);
        }
      }
    }

    if (msg.type === "sync" && inLobby) {
      channel.postMessage({
        type: "roster",
        to: msg.from,
        roster: Array.from(lobby.entries()).map(([id, v]) => [id, v.name, v.ts])
      });
    }

    if (msg.type === "roster" && msg.to === myId) {
      msg.roster.forEach(([id, name, ts]) => {
        lobby.set(id, { name, ts: ts || Date.now() });
      });
      renderLobby();
      assignLanes();
      if (mode === "lobby" && lobby.size >= 2) {
        stopMatchTimer();
        startRaceCountdownIfReady();
      }
    }

    if (msg.type === "countdown" && mode === "lobby") {
      if (lobby.size < 2) return;
      raceCountdownLeft = Number(msg.seconds || 0);
      if (raceCountdownLeft > 0) setLobbyStatus(`Match found. Race starts in ${raceCountdownLeft}s…`);
    }

    if (msg.type === "start") {
      if (mode === "lobby" && lobby.size >= 2) beginRace(msg.startTs);
    }

    if (msg.type === "progress") {
      if (mode !== "race") return;
      if (!lobby.has(msg.id)) return;
      progress.set(msg.id, Math.max(0, Number(msg.correct || 0)));
    }
  };

  btnEnter.addEventListener("click", joinLobby);
  btnPractice.addEventListener("click", beginPractice);
  btnLeave.addEventListener("click", leaveLobby);

  btnNew.addEventListener("click", () => {
    if (mode === "practice") { beginPractice(); return; }
    if (mode === "lobby") { leaveLobby(); joinLobby(); return; }
    if (mode === "race") { leaveLobby(); joinLobby(); }
  });

  window.addEventListener("beforeunload", () => {
    if (inLobby) channel.postMessage({ type: "leave", id: myId });
  });

  resetTrack();
  assignLanes();
  renderLobby();
  setButtons();
  setLobbyStatus("Not in a lobby.");
})();
</script>
</body>
</html>
